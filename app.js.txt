// We fetch the NOAA daily Mauna Loa file via a CORS proxy
// because browsers block direct cross-site access (CORS).
// NOAA source: https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_daily_mlo.txt
// Proxy: https://api.allorigins.win/raw?url=...

const NOAA_URL =
  "https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_daily_mlo.txt";
const DATA_URL =
  "https://api.allorigins.win/raw?url=" + encodeURIComponent(NOAA_URL);

const valueEl = document.getElementById("co2-value");
const dateEl = document.getElementById("date-label").querySelector("strong");
const statusEl = document.getElementById("status");

async function fetchCO2() {
  try {
    statusEl.textContent = "Fetching latest value…";

    const resp = await fetch(DATA_URL, {
      cache: "no-cache"
    });

    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }

    const text = await resp.text();
    const lines = text.trim().split("\n");

    // Walk up from the bottom until we find a real data line
    let co2 = null;
    let year, month, day;

    for (let i = lines.length - 1; i >= 0; i--) {
      const line = lines[i].trim();

      // Skip comments and blanks
      if (line === "" || line.startsWith("#")) continue;

      const parts = line.split(/\s+/);
      if (parts.length < 5) continue;

      year = parts[0];
      month = parts[1];
      day = parts[2];
      const value = parseFloat(parts[4]); // daily mean ppm

      // Skip missing data values (e.g. -99.99) or obviously invalid
      if (!Number.isFinite(value) || value < 200 || value > 700) continue;

      co2 = value;
      break;
    }

    if (co2 === null) {
      throw new Error("Could not find a valid CO₂ value in the file");
    }

    // Update display
    valueEl.textContent = co2.toFixed(2);
    const mm = String(month).padStart(2, "0");
    const dd = String(day).padStart(2, "0");
    dateEl.textContent = `${year}-${mm}-${dd}`;

    const updated = new Date().toLocaleString();
    statusEl.textContent = `Last updated from NOAA (via proxy): ${updated}`;
  } catch (err) {
    console.error(err);
    statusEl.innerHTML =
      '<span class="error">Error fetching CO₂ data. Please check your connection or try again later.</span>';
  }
}

// Run once on load
fetchCO2();
